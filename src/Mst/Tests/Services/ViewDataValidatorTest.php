<?php

namespace Mst\Tests\Services;

use Mst\Services\ViewDataValidator;

/**
 * @author javi
 */
class ViewDataValidatorTest extends \PHPUnit_Framework_TestCase
{   
    /** @var string */
    protected $dataIsValid = '{ "id": 1 }';
    /** @var string */
    protected $dataIsValidSave = '{ "name": "test", "zoom": 1, "schema": { "entities": [{ "x": 93, "y": 58, "fields": [{ "relations": [], "id": "13add6596hhde9ghb3c5", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": [], "id": "02d86358542g17592beh", "name": "name", "tableName": "name", "length": 255, "pk": false, "nn": true, "default": null, "type": "string" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "c0239139eb640d6b6geg", "entityName": "Category", "tableName": "category", "namespace": "AppBundle\\Entity" }, { "x": 406, "y": 69, "fields": [{ "relations": [], "id": "51b8d1cg8b5d02ba2hc1", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0", "gh99fb4f7869a686ggdb"], "id": "g82c0c95ebf04959g7ce", "entityName": "Post", "tableName": "post", "namespace": "AppBundle\\Entity" }, { "x": 724, "y": 59, "fields": [{ "relations": [], "id": "hdb0e7eh25bg1609a857", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["gh99fb4f7869a686ggdb"], "id": "bff2340h6e3af757606b", "entityName": "Tag", "tableName": "tag", "namespace": "AppBundle\\Entity" }], "relations": [{ "connectionId": "6e8ddg4edf3e8c4h59f0", "name": "One to many", "type": 2, "hoverClass": "oneToManyHover", "cascadeOptions": [], "sourceEntityId": "c0239139eb640d6b6geg", "targetEntityId": "g82c0c95ebf04959g7ce", "sourceFieldId": "5h1ga7ed8727d26f34b1", "targetFieldId": "ga4072g7a6837562c9bd", "sourceField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }, { "connectionId": "gh99fb4f7869a686ggdb", "name": "Many to many", "type": 3, "hoverClass": "manyToManyHover", "cascadeOptions": [], "sourceEntityId": "g82c0c95ebf04959g7ce", "targetEntityId": "bff2340h6e3af757606b", "sourceFieldId": "ea1g8e4h5c8h8fh6bebe", "targetFieldId": "1a8g60a378a40e5h2865", "sourceField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "hdb0e7eh25bg1609a857", "tableName": "post_tag", "sourceRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }] } }';
    /** @var string */
    protected $dataIsValidProccess = '{ "entities": [{ "x": 93, "y": 58, "fields": [{ "relations": [], "id": "13add6596hhde9ghb3c5", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": [], "id": "02d86358542g17592beh", "name": "name", "tableName": "name", "length": 255, "pk": false, "nn": true, "default": null, "type": "string" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "c0239139eb640d6b6geg", "entityName": "Category", "tableName": "category", "namespace": "AppBundle\\Entity" }, { "x": 406, "y": 69, "fields": [{ "relations": [], "id": "51b8d1cg8b5d02ba2hc1", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0", "gh99fb4f7869a686ggdb"], "id": "g82c0c95ebf04959g7ce", "entityName": "Post", "tableName": "post", "namespace": "AppBundle\\Entity" }, { "x": 724, "y": 59, "fields": [{ "relations": [], "id": "hdb0e7eh25bg1609a857", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["gh99fb4f7869a686ggdb"], "id": "bff2340h6e3af757606b", "entityName": "Tag", "tableName": "tag", "namespace": "AppBundle\\Entity" }], "relations": [{ "connectionId": "6e8ddg4edf3e8c4h59f0", "name": "One to many", "type": 2, "hoverClass": "oneToManyHover", "cascadeOptions": [], "sourceEntityId": "c0239139eb640d6b6geg", "targetEntityId": "g82c0c95ebf04959g7ce", "sourceFieldId": "5h1ga7ed8727d26f34b1", "targetFieldId": "ga4072g7a6837562c9bd", "sourceField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }, { "connectionId": "gh99fb4f7869a686ggdb", "name": "Many to many", "type": 3, "hoverClass": "manyToManyHover", "cascadeOptions": [], "sourceEntityId": "g82c0c95ebf04959g7ce", "targetEntityId": "bff2340h6e3af757606b", "sourceFieldId": "ea1g8e4h5c8h8fh6bebe", "targetFieldId": "1a8g60a378a40e5h2865", "sourceField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "hdb0e7eh25bg1609a857", "tableName": "post_tag", "sourceRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }] }';

    public function testValidateSchema()
    {
        $vdv = new ViewDataValidator();
        
        $data = '{ "foo": "foo", "bar": "bar" }';
        $schema = '{ "$schema": "http://json-schema.org/draft-04/schema#", "type": "object", "properties": { "foo": { "type": "string" }, "bar": { "type": "string" } }, "required": [ "foo", "bar" ] }';
        
        $this->assertTrue($vdv->isValidJson($data, $schema));
    }
    
    public function testValidateSchemaFail()
    {
        $vdv = new ViewDataValidator();
        
        $data = '{ "fail": 1, "foo": "foo", "bar": "bar" }';
        $schema = '{ "$schema": "http://json-schema.org/draft-04/schema#", "type": "object", "properties": { "foo": { "type": "string" }, "bar": { "type": "string" } }, "required": [ "foo", "bar" ] }';
        
        $this->assertTrue($vdv->isValidJson($data, $schema));
    }
    
    public function testIsValidJson()
    {
        $vdv = new ViewDataValidator();
        
        $this->assertTrue($vdv->isValidJson(stripslashes($this->dataIsValid)));
    }
    
    public function testIsValidJsonFail()
    {
        $vdv = new ViewDataValidator();
        
        $this->assertTrue($vdv->isValidJson(stripslashes('{ "foo": "bar" }')));
    }
    
    public function testIsValidSaveData()
    {
        $vdv = new ViewDataValidator();
        
        $this->assertTrue($vdv->isValidSaveData(stripslashes($this->dataIsValidSave)));
    }
    
    public function testIsValidSaveDataFail()
    {
        $vdv = new ViewDataValidator();
        
        $this->assertTrue($vdv->isValidSaveData(stripslashes('{ "foo": "bar", "name": "test", "zoom": 1, "schema": { "entities": [{ "x": 93, "y": 58, "fields": [{ "relations": [], "id": "13add6596hhde9ghb3c5", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": [], "id": "02d86358542g17592beh", "name": "name", "tableName": "name", "length": 255, "pk": false, "nn": true, "default": null, "type": "string" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "c0239139eb640d6b6geg", "entityName": "Category", "tableName": "category", "namespace": "AppBundle\\Entity" }, { "x": 406, "y": 69, "fields": [{ "relations": [], "id": "51b8d1cg8b5d02ba2hc1", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0", "gh99fb4f7869a686ggdb"], "id": "g82c0c95ebf04959g7ce", "entityName": "Post", "tableName": "post", "namespace": "AppBundle\\Entity" }, { "x": 724, "y": 59, "fields": [{ "relations": [], "id": "hdb0e7eh25bg1609a857", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["gh99fb4f7869a686ggdb"], "id": "bff2340h6e3af757606b", "entityName": "Tag", "tableName": "tag", "namespace": "AppBundle\\Entity" }], "relations": [{ "connectionId": "6e8ddg4edf3e8c4h59f0", "name": "One to many", "type": 2, "hoverClass": "oneToManyHover", "cascadeOptions": [], "sourceEntityId": "c0239139eb640d6b6geg", "targetEntityId": "g82c0c95ebf04959g7ce", "sourceFieldId": "5h1ga7ed8727d26f34b1", "targetFieldId": "ga4072g7a6837562c9bd", "sourceField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }, { "connectionId": "gh99fb4f7869a686ggdb", "name": "Many to many", "type": 3, "hoverClass": "manyToManyHover", "cascadeOptions": [], "sourceEntityId": "g82c0c95ebf04959g7ce", "targetEntityId": "bff2340h6e3af757606b", "sourceFieldId": "ea1g8e4h5c8h8fh6bebe", "targetFieldId": "1a8g60a378a40e5h2865", "sourceField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "hdb0e7eh25bg1609a857", "tableName": "post_tag", "sourceRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }] } }')));
    }
    
    public function testIsValidProccessData()
    {
        $vdv = new ViewDataValidator();
        
        $this->assertTrue($vdv->isValidProccessData(stripslashes($this->dataIsValidProccess)));
    }
    
    public function testIsValidProccessDataFail()
    {
        $vdv = new ViewDataValidator();
        
        $this->assertTrue($vdv->isValidProccessData(stripslashes('{ "foo": "bar", "entities": [{ "x": 93, "y": 58, "fields": [{ "relations": [], "id": "13add6596hhde9ghb3c5", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": [], "id": "02d86358542g17592beh", "name": "name", "tableName": "name", "length": 255, "pk": false, "nn": true, "default": null, "type": "string" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "c0239139eb640d6b6geg", "entityName": "Category", "tableName": "category", "namespace": "AppBundle\\Entity" }, { "x": 406, "y": 69, "fields": [{ "relations": [], "id": "51b8d1cg8b5d02ba2hc1", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["6e8ddg4edf3e8c4h59f0", "gh99fb4f7869a686ggdb"], "id": "g82c0c95ebf04959g7ce", "entityName": "Post", "tableName": "post", "namespace": "AppBundle\\Entity" }, { "x": 724, "y": 59, "fields": [{ "relations": [], "id": "hdb0e7eh25bg1609a857", "name": "id", "tableName": "id", "length": 0, "pk": true, "nn": false, "type": "integer", "default": null, "strategy": "AUTO" }, { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }], "relations": ["gh99fb4f7869a686ggdb"], "id": "bff2340h6e3af757606b", "entityName": "Tag", "tableName": "tag", "namespace": "AppBundle\\Entity" }], "relations": [{ "connectionId": "6e8ddg4edf3e8c4h59f0", "name": "One to many", "type": 2, "hoverClass": "oneToManyHover", "cascadeOptions": [], "sourceEntityId": "c0239139eb640d6b6geg", "targetEntityId": "g82c0c95ebf04959g7ce", "sourceFieldId": "5h1ga7ed8727d26f34b1", "targetFieldId": "ga4072g7a6837562c9bd", "sourceField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "5h1ga7ed8727d26f34b1", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["6e8ddg4edf3e8c4h59f0"], "id": "ga4072g7a6837562c9bd", "name": "category", "tableName": "id_category", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }, { "connectionId": "gh99fb4f7869a686ggdb", "name": "Many to many", "type": 3, "hoverClass": "manyToManyHover", "cascadeOptions": [], "sourceEntityId": "g82c0c95ebf04959g7ce", "targetEntityId": "bff2340h6e3af757606b", "sourceFieldId": "ea1g8e4h5c8h8fh6bebe", "targetFieldId": "1a8g60a378a40e5h2865", "sourceField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "ea1g8e4h5c8h8fh6bebe", "name": "tag", "tableName": "id_tag", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetField": { "relations": ["gh99fb4f7869a686ggdb"], "id": "1a8g60a378a40e5h2865", "name": "post", "tableName": "id_post", "length": 0, "pk": false, "nn": false, "type": "", "default": null }, "targetRelatedFieldId": "hdb0e7eh25bg1609a857", "tableName": "post_tag", "sourceRelatedFieldId": "51b8d1cg8b5d02ba2hc1" }] }')));
    }
}
